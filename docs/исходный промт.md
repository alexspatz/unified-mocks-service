  
\# Unified Mocks Service с Telegram-управлением  
Необходимо создать унифицированный сервис-эмулятор для трех edge-адаптеров, используемых в бэкенде киоска самообслуживания: Payment Edge, Fiscal Edge и KDS (Kitchen Display System) Edge. Сервис должен быть реализован как единое HTTP-приложение (на FastAPI) с интеграцией Telegram бота для управления и мониторинга.  
\#\# Ключевые цели:  
1\. Единый сервис для всех моков (один процесс)  
2\. Управление через Telegram бота:  
   \- Настройка режима работы каждого сервиса (SUCCESS/DECLINED/MANUAL/SEQUENCE)  
   \- Ручная обработка запросов через Telegram  
   \- Логирование всех запросов в сервисный чат  
3\. Railway деплой и Git интеграция  
4\. Конфигурируемые сценарии для каждого шлюза  
5\. Поддержка последовательности ответов  
\#\# Архитектура:  
1\. FastAPI приложение  
2\. Telegram бот (python-telegram-bot)  
3\. In-memory хранилище для конфигурации и логов  
4\. Railway деплой  
\#\# Компоненты системы:  
\#\#\# 1\. Конфигурация сервиса:  
\`\`\`python  
class ServiceMode(str, Enum):  
    AUTO\_SUCCESS \= "AUTO\_SUCCESS"  
    AUTO\_FAILURE \= "AUTO\_FAILURE"  
    MANUAL \= "MANUAL"  
    SEQUENCE \= "SEQUENCE"  
class ServiceConfig:  
    mode: ServiceMode  
    timeout\_seconds: int  \# для ручного режима  
    default\_response: str  \# ответ по таймауту  
    sequence\_config: Optional\[dict\] \= {  
        "success\_count": int,  \# количество успешных ответов  
        "failure\_count": int,  \# количество неуспешных ответов  
        "remaining": List\[str\]  \# текущая последовательность  
    }

**2\. Telegram Bot функционал:**

**Команды бота:**

	•	/status \- краткий статус всех сервисов

	•	/status\_detailed \- подробный статус с информацией о последовательностях

	•	/config \- меню настройки сервисов

	•	/config\_all \- быстрая настройка всех сервисов одновременно

	•	/logs \- последние N логов

	•	/help \- справка по командам

**Настройка сервисов через бота:**

Для каждого сервиса (Payment/Fiscal/KDS):

	•	Всегда успешно

	•	Всегда неуспешно

	•	Ручной режим

	•	Последовательность ответов (пример: 5 успешных, 2 неуспешных)

**Ручная обработка:**

	•	Запрос приходит в сервисный чат

	•	Inline кнопки для выбора ответа

	•	Настраиваемый таймаут

	•	При истечении таймаута \- возврат дефолтного ответа

**3\. Пример конфигурации:**  
{  
    "payment": {  
        "mode": "SEQUENCE",  
        "timeout\_seconds": 30,  
        "default\_response": "SUCCESS",  
        "sequence\_config": {  
            "success\_count": 5,  
            "failure\_count": 2,  
            "remaining": \["SUCCESS", "SUCCESS", "FAILURE", "SUCCESS", "FAILURE", "SUCCESS", "SUCCESS"\]  
        }  
    },  
    "fiscal": {  
        "mode": "MANUAL",  
        "timeout\_seconds": 45,  
        "default\_response": "OK"  
    },  
    "kds": {  
        "mode": "AUTO\_SUCCESS",  
        "timeout\_seconds": 30,  
        "default\_response": "OK"  
    }  
}

**4\. Telegram Bot конфигурация:**  
TELEGRAM\_ADMIN\_IDS \= \[123456789, 987654321\]  \# ID администраторов  
TELEGRAM\_CHAT\_ID \= "-100123456789"  \# ID сервисного чата для логов

**API Endpoints:**

**Payment Edge Mock:**

POST /mocks/payment

\#\#\# 1\. Payment Edge Mock:  
\#\#\#\# CLIENT DONT PAY CASE — request  
\`\`\`json  
{  
  "kiosk\_id": "kiosk\_001",  
  "order\_id": 9999995,  
  "sum": 57000  
}

**CLIENT DONT PAY CASE — response**  
{  
  "payment\_id": 1809,  
  "order\_id": 9999995,  
  "session\_id": "9999995-20250930T180127Z",  
  "status": "DECLINED",  
  "auth\_code": null,  
  "rrn": null,  
  "transaction\_id": "0",  
  "terminal\_id": "00092240",  
  "merchant\_id": "0",  
  "response\_code": "ER3",  
  "response\_message": "ОПЕРАЦИЯ ПРЕРВАНА^TERMINATED.JPG\~",  
  "amount": 57000,  
  "currency\_code": "643",  
  "payment\_date": "2025-09-30T18:01:27.460992+00:00",  
  "completed\_at": "2025-09-30T18:01:58.686168+00:00",  
  "receipt\_available": false,  
  "field\_90\_raw": "\<?xml version=\\"1.0\\" encoding=\\"UTF-8\\" standalone=\\"no\\"?\>\<response\>\<field id=\\"0\\"\>57000\</field\>\<field id=\\"4\\"\>643\</field\>\<field id=\\"6\\"\>20250930180321\</field\>\<field id=\\"15\\"\>ER3\</field\>\<field id=\\"19\\"\>ОПЕРАЦИЯ ПРЕРВАНА^TERMINATED.JPG\~\</field\>\<field id=\\"21\\"\>20250930180321\</field\>\<field id=\\"23\\"\>0\</field\>\<field id=\\"25\\"\>1\</field\>\<field id=\\"26\\"\>0\</field\>\<field id=\\"27\\"\>00092240\</field\>\<field id=\\"28\\"\>0\</field\>\<field id=\\"39\\"\>53\</field\>\</response\>",  
  "customer\_receipt": null,  
  "merchant\_receipt": null  
}

**CLIENT PAID CASE — request**  
{  
  "kiosk\_id": "kiosk\_001",  
  "order\_id": 9999996,  
  "sum": 57000  
}

**CLIENT PAID CASE — response**  
{  
  "payment\_id": 1810,  
  "order\_id": 9999996,  
  "session\_id": "9999996-20250930T180348Z",  
  "status": "SUCCESS",  
  "auth\_code": "873793",  
  "rrn": "000010001446",  
  "transaction\_id": "0",  
  "terminal\_id": "00092240",  
  "merchant\_id": "11111111",  
  "response\_code": "00",  
  "response\_message": "ОДОБРЕНО",  
  "amount": 57000,  
  "currency\_code": "643",  
  "payment\_date": "2025-09-30T18:03:48.057043+00:00",  
  "completed\_at": "2025-09-30T18:04:07.401415+00:00",  
  "receipt\_available": true,  
  "field\_90\_raw": "\<?xml version=\\"1.0\\" encoding=\\"UTF-8\\" standalone=\\"no\\"?\>\<response\>...truncated for brevity...\</response\>",  
  "customer\_receipt": "...receipt text (HTML/escaped) ...",  
  "merchant\_receipt": "...receipt text (HTML/escaped) ..."  
}

**2\. Fiscal Edge Mock:**

**Request**  
{  
  "order\_id": 9999996,  
  "kiosk\_id": "kiosk\_001",  
  "items": \[  
    {  
      "item\_id": 123,  
      "item\_description": "Cappuccino 250ml",  
      "item\_price\_net": 30000,  
      "item\_price\_gross": 36000,  
      "item\_vat\_value": 6000,  
      "quantity": 1  
    }  
  \],  
  "total\_net": 30000,  
  "total\_vat": 6000,  
  "total\_gross": 36000,  
  "payment\_method": "CARD"  
}

**Success Response**  
{  
  "status": "OK",  
  "fiscal\_receipt": {  
    "ofd\_reg\_number": "1234567890",  
    "fiscal\_document\_number": "FD-TEST-0001",  
    "fn\_number": "TEST-FN-0000000000000",  
    "order\_id": 9999996,  
    "issued\_at": "2025-09-30T18:05:30+00:00",  
    "items": \[  
      {  
        "item\_id": 123,  
        "description": "Cappuccino 250ml",  
        "quantity": 1,  
        "price\_net": 30000,  
        "vat": 6000,  
        "price\_gross": 36000  
      }  
    \],  
    "total\_net": 30000,  
    "total\_vat": 6000,  
    "total\_gross": 36000,  
    "message": "Fiscal receipt generated (test)"  
  }  
}

**Failure Response**  
{  
  "status": "NOT\_OK",  
  "error\_code": "FISCAL\_ERR\_01",  
  "error\_message": "Fiscalization failed: OFD communication error (simulated)"  
}

**3\. KDS (Kitchen Display System) Mock:**

**Request**  
{  
  "order\_id": 9999996,  
  "kiosk\_id": "kiosk\_001",  
  "items": \[  
    {"item\_id": 123, "description": "Cappuccino 250ml", "quantity": 1},  
    {"item\_id": 124, "description": "Bagel", "quantity": 2}  
  \]  
}

**Success Response**  
{  
  "status": "OK",  
  "kds\_ticket\_id": "KDS-TEST-0001",  
  "received\_at": "2025-09-30T18:06:00+00:00"  
}

**Failure Response**  
{  
  "status": "NOT\_OK",  
  "error\_code": "KDS\_ERR\_01",  
  "error\_message": "KDS reject: kitchen busy (simulated)"  
}

**4\. Configuration API:**

**GET /mocks/config**

Возвращает текущую конфигурацию всех сервисов

**POST /mocks/config**  
{  
  "payment": {  
    "mode": "SEQUENCE",  
    "timeout\_seconds": 30,  
    "default\_response": "SUCCESS",  
    "sequence\_config": {  
      "success\_count": 5,  
      "failure\_count": 2  
    }  
  },  
  "fiscal": {  
    "mode": "MANUAL",  
    "timeout\_seconds": 45,  
    "default\_response": "OK"  
  },  
  "kds": {  
    "mode": "AUTO\_SUCCESS"  
  }  
}

**5\. Logs API:**

**GET /mocks/logs?limit=100**

Возвращает последние логи в формате:  
{  
  "logs": \[  
    {  
      "timestamp": "2025-09-30T18:06:00+00:00",  
      "service": "payment",  
      "request": {},  
      "response": {},  
      "mode": "SEQUENCE",  
      "status": "SUCCESS"  
    }  
  \]  
}

**Railway Deployment:**  
\# railway.json  
{  
  "build": {  
    "builder": "NIXPACKS"  
  },  
  "deploy": {  
    "startCommand": "uvicorn main:app \--host 0.0.0.0 \--port $PORT",  
    "restartPolicyType": "ON\_FAILURE",  
    "restartPolicyMaxRetries": 10  
  }  
}

**Важные замечания по реализации:**

	1\.	Все временные метки должны генерироваться динамически в текущей временной зоне

	2\.	Суммы в ответах должны соответствовать суммам в запросах

	3\.	field\_90\_raw и receipts должны сохраняться как в примерах

	4\.	Все ID (payment\_id, session\_id и т.д.) должны генерироваться последовательно

	5\.	Таймауты в ручном режиме должны быть настраиваемыми

	6\.	Последовательности ответов должны генерироваться случайно в рамках указанных пропорций

